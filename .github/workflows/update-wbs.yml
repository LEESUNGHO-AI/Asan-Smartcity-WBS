name: Update WBS Data from Notion

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  fetch-notion-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug token (length only, no value)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          echo "Token length: ${#NOTION_TOKEN}"
          echo "Token prefix: ${NOTION_TOKEN:0:4}"
          # 공백/줄바꿈 제거 후 길이 확인
          CLEAN=$(echo -n "$NOTION_TOKEN" | tr -d '[:space:]')
          echo "Clean token length: ${#CLEAN}"

      - name: Fetch Notion WBS data
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import urllib.request
          import urllib.error
          import json, os, time

          # 공백/줄바꿈 완전 제거
          NOTION_TOKEN = os.environ['NOTION_TOKEN'].strip()
          DB_ID = '559654aed9404d9f88225ea0adc7d746'

          print(f"Token prefix: {NOTION_TOKEN[:8]}...")
          print(f"Token length: {len(NOTION_TOKEN)}")

          def notion_query(cursor=None):
              url = f'https://api.notion.com/v1/databases/{DB_ID}/query'
              body = {'page_size': 100}
              if cursor:
                  body['start_cursor'] = cursor
              req = urllib.request.Request(
                  url,
                  data=json.dumps(body).encode(),
                  headers={
                      'Authorization': f'Bearer {NOTION_TOKEN}',
                      'Notion-Version': '2022-06-28',
                      'Content-Type': 'application/json'
                  },
                  method='POST'
              )
              with urllib.request.urlopen(req) as r:
                  return json.loads(r.read())

          def get_text(prop):
              if not prop: return ''
              t = prop.get('type','')
              if t == 'title':
                  return prop['title'][0]['plain_text'] if prop['title'] else ''
              if t == 'rich_text':
                  return prop['rich_text'][0]['plain_text'] if prop['rich_text'] else ''
              if t == 'select':
                  return prop['select']['name'] if prop['select'] else ''
              if t == 'number':
                  return prop['number'] if prop['number'] is not None else ''
              if t == 'date':
                  return prop['date']['start'] if prop['date'] else ''
              return ''

          all_pages = []
          cursor = None
          while True:
              res = notion_query(cursor)
              all_pages.extend(res['results'])
              if not res.get('has_more'):
                  break
              cursor = res.get('next_cursor')
              time.sleep(0.3)

          print(f'총 {len(all_pages)}건 로드')

          records = []
          for p in all_pages:
              props = p.get('properties', {})
              records.append({
                  'id':           p['id'],
                  'taskId':       get_text(props.get('작업명')),
                  'name':         get_text(props.get('Name')),
                  'level':        get_text(props.get('Level')),
                  'category':     get_text(props.get('대분류')),
                  'subCategory':  get_text(props.get('중분류')),
                  'organization': get_text(props.get('담당기관')),
                  'manager':      get_text(props.get('담당R')),
                  'collaborator': get_text(props.get('협업C')),
                  'startDate':    get_text(props.get('시작일')),
                  'endDate':      get_text(props.get('종료일')),
                  'duration':     get_text(props.get('기간')),
                  'weight':       get_text(props.get('가중치')),
                  'plannedRate':  get_text(props.get('계획공정률')),
                  'actualRate':   get_text(props.get('실적공정률')),
                  'progressRate': get_text(props.get('진행률')),
                  'deviation':    get_text(props.get('진척차')),
                  'deliverable':  get_text(props.get('산출물')),
                  'evidence':     get_text(props.get('근거자료')),
                  'predecessor':  get_text(props.get('선행작업')),
                  'note':         get_text(props.get('비고')),
                  'url':          get_text(props.get('URL')),
              })

          def sort_key(r):
              tid = r.get('taskId','')
              try:
                  return [int(x) for x in tid.split('.')] + [0]*5
              except:
                  return [9999]

          records.sort(key=sort_key)

          output = {
              'updated_at': time.strftime('%Y-%m-%dT%H:%M:%S+09:00',
                            time.gmtime(time.time() + 9*3600)),
              'total': len(records),
              'records': records
          }

          with open('data.json', 'w', encoding='utf-8') as f:
              json.dump(output, f, ensure_ascii=False, indent=2)

          print(f'data.json 저장 완료: {len(records)}건')
          PYEOF

      - name: Commit and push data.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --staged --quiet || git commit -m "auto: Notion WBS 데이터 갱신 $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M KST')"
          git push
