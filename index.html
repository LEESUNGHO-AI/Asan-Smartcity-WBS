<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ—ï¸ ì•„ì‚° ìŠ¤ë§ˆíŠ¸ì‹œí‹° WBS 2026 ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #1a56db; --primary-light: #e8f0fe;
    --success: #0f9d58; --warning: #f4b400; --danger: #db4437;
    --bg: #f8f9fa; --card: #ffffff; --border: #e0e0e0;
    --text: #202124; --text-sub: #5f6368;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans KR', -apple-system, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

  header { background: linear-gradient(135deg, #1a56db 0%, #0d3785 100%); color: white; padding: 20px 32px; }
  header h1 { font-size: 22px; font-weight: 700; }
  header p  { font-size: 13px; opacity: .8; margin-top: 4px; }
  .sync-badge { display: inline-block; background: rgba(255,255,255,.2); border-radius: 12px; padding: 3px 12px; font-size: 12px; margin-top: 8px; }

  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px 32px 0; }
  .kpi { background: var(--card); border-radius: 10px; padding: 18px 20px; border: 1px solid var(--border); }
  .kpi-val { font-size: 28px; font-weight: 700; color: var(--primary); }
  .kpi-lbl { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

  .tabs { display: flex; gap: 0; padding: 20px 32px 0; border-bottom: 2px solid var(--border); background: white; }
  .tab  { padding: 10px 24px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; font-weight: 500; color: var(--text-sub); transition: .2s; }
  .tab:hover { color: var(--primary); }
  .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

  .content { padding: 24px 32px; display: none; }
  .content.active { display: block; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .card  { background: var(--card); border-radius: 10px; padding: 20px; border: 1px solid var(--border); }
  .card h3 { font-size: 14px; font-weight: 600; margin-bottom: 14px; color: var(--text-sub); }

  .filters { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
  .filters select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: white; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th    { background: #f1f3f4; padding: 9px 10px; text-align: left; font-weight: 600; position: sticky; top: 0; white-space: nowrap; }
  td    { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
  tr:hover td { background: #f8f9ff; }

  .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; white-space: nowrap; }
  .badge-wait  { background: #feefc3; color: #7a4400; }
  .badge-ing   { background: #d2e3fc; color: #174ea6; }
  .badge-done  { background: #ceead6; color: #137333; }
  .badge-lv1   { background: #e8eaed; color: #444; }
  .badge-lv2   { background: #e0f0ff; color: #0d47a1; }
  .badge-lv3   { background: #fce8ff; color: #5c007a; }

  .pbar-wrap { display: flex; align-items: center; gap: 8px; }
  .pbar      { flex: 1; height: 8px; background: #e8eaed; border-radius: 4px; overflow: hidden; min-width: 60px; }
  .pbar-fill { height: 100%; border-radius: 4px; transition: width .3s; }
  .pbar-num  { font-size: 12px; color: var(--text-sub); white-space: nowrap; width: 42px; text-align: right; }

  .org-chip { display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .org-0 { background: #e8f0fe; color: #1a56db; }
  .org-1 { background: #fce8b2; color: #7a4400; }
  .org-2 { background: #d2e3fc; color: #0d47a1; }
  .org-3 { background: #ceead6; color: #137333; }
  .org-4 { background: #fce8ff; color: #5c007a; }

  .dev-neg { color: var(--danger); font-weight: 600; }
  .dev-pos { color: var(--success); font-weight: 600; }

  .tbl-wrap { overflow-x: auto; max-height: 520px; overflow-y: auto; border-radius: 8px; border: 1px solid var(--border); }

  @media (max-width: 768px) {
    .kpi-row { grid-template-columns: 1fr 1fr; padding: 16px; }
    .grid2   { grid-template-columns: 1fr; }
    .content { padding: 16px; }
    header   { padding: 16px; }
  }

  #loading { text-align: center; padding: 60px; color: var(--text-sub); font-size: 16px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ—ï¸ ì•„ì‚° ìŠ¤ë§ˆíŠ¸ì‹œí‹° WBS 2026 ëŒ€ì‹œë³´ë“œ</h1>
  <p>ì•„ì‚°ì‹œ ê°•ì†Œí˜• ìŠ¤ë§ˆíŠ¸ì‹œí‹° ì¡°ì„±ì‚¬ì—… â€” ë‹¨ìœ„ì‚¬ì—… + ì‚¬ì—…ê´€ë¦¬ WBS í†µí•© í˜„í™©</p>
  <span class="sync-badge" id="syncBadge">â³ ë¡œë”© ì¤‘...</span>
</header>

<div id="loading">ğŸ“¡ WBS ë°ì´í„° ë¡œë”© ì¤‘...</div>

<div id="main" style="display:none">
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-val" id="kpi-total">-</div><div class="kpi-lbl">ì „ì²´ ì‘ì—… ìˆ˜</div></div>
    <div class="kpi"><div class="kpi-val" id="kpi-done">-</div><div class="kpi-lbl">ì™„ë£Œ ì‘ì—…</div></div>
    <div class="kpi"><div class="kpi-val" id="kpi-avg-actual" style="color:var(--success)">-</div><div class="kpi-lbl">í‰ê·  ì‹¤ì  ê³µì •ë¥ </div></div>
    <div class="kpi"><div class="kpi-val" id="kpi-avg-dev" style="color:var(--danger)">-</div><div class="kpi-lbl">í‰ê·  ì§„ì²™ì°¨</div></div>
  </div>

  <div class="tabs" style="margin-top:20px">
    <div class="tab active" onclick="switchTab('all')">ğŸ“Š ì „ì²´ í˜„í™©</div>
    <div class="tab" onclick="switchTab('category')">ğŸ¯ ëŒ€ë¶„ë¥˜ë³„</div>
    <div class="tab" onclick="switchTab('org')">ğŸ‘¥ ë‹´ë‹¹ê¸°ê´€ë³„</div>
  </div>

  <!-- ì „ì²´ í˜„í™© íƒ­ -->
  <div class="content active" id="tab-all">
    <div class="grid2">
      <div class="card"><h3>ğŸ“ˆ ëŒ€ë¶„ë¥˜ë³„ ì‹¤ì  ê³µì •ë¥ </h3><canvas id="chartCategory" height="200"></canvas></div>
      <div class="card"><h3>ğŸ¢ ë‹´ë‹¹ê¸°ê´€ë³„ ì§„í–‰í˜„í™©</h3><canvas id="chartOrg" height="200"></canvas></div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ì „ì²´ ì—…ë¬´ ëª©ë¡</h3>
      <div class="filters">
        <select id="f-level" onchange="renderAllTable()">
          <option value="">ì „ì²´ Level</option>
          <option value="1">Level 1</option>
          <option value="2">Level 2</option>
          <option value="3">Level 3</option>
        </select>
        <select id="f-cat" onchange="renderAllTable()"><option value="">ì „ì²´ ëŒ€ë¶„ë¥˜</option></select>
        <select id="f-org" onchange="renderAllTable()"><option value="">ì „ì²´ ê¸°ê´€</option></select>
        <select id="f-status" onchange="renderAllTable()">
          <option value="">ì „ì²´ ìƒíƒœ</option>
          <option value="done">ì™„ë£Œ</option>
          <option value="ing">ì§„í–‰ì¤‘</option>
          <option value="wait">ëŒ€ê¸°</option>
        </select>
      </div>
      <div class="tbl-wrap">
        <table><thead><tr>
          <th>WBS</th><th>Lv</th><th>ì—…ë¬´ í•­ëª©</th><th>ëŒ€ë¶„ë¥˜</th>
          <th>ë‹´ë‹¹ê¸°ê´€</th><th>ê³„íš(%)</th><th>ì‹¤ì (%)</th><th>ì§„ì²™ì°¨</th>
        </tr></thead>
        <tbody id="tbody-all"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ëŒ€ë¶„ë¥˜ë³„ íƒ­ -->
  <div class="content" id="tab-category">
    <div class="grid2" id="category-cards"></div>
  </div>

  <!-- ë‹´ë‹¹ê¸°ê´€ë³„ íƒ­ -->
  <div class="content" id="tab-org">
    <div class="grid2" id="org-cards"></div>
  </div>
</div>

<script>
let allData = [];

// â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const res = await fetch('data.json?t=' + Date.now());
    if (!res.ok) throw new Error('data.json ë¡œë“œ ì‹¤íŒ¨');
    const json = await res.json();
    allData = json.records || [];

    const dt = new Date(json.updated_at);
    const label = dt.toLocaleString('ko-KR', {timeZone:'Asia/Seoul',
      month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    document.getElementById('syncBadge').textContent = `ğŸ”„ ë§ˆì§€ë§‰ ë™ê¸°í™”: ${label} KST`;

    document.getElementById('loading').style.display = 'none';
    document.getElementById('main').style.display = 'block';

    initFilters();
    renderKPI();
    renderCharts();
    renderAllTable();
    renderCategoryCards();
    renderOrgCards();
  } catch(e) {
    document.getElementById('loading').innerHTML =
      `âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}<br><small>GitHub Actionsê°€ data.jsonì„ ì•„ì§ ìƒì„±í•˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;
  }
}

// â”€â”€ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pct(v) {
  if (v === '' || v === null || v === undefined) return null;
  const n = parseFloat(String(v).replace('%',''));
  if (isNaN(n)) return null;
  return Math.abs(n) <= 1 ? Math.round(n * 100) : Math.round(n);
}
function status(r) {
  const a = pct(r.actualRate);
  if (a === null) return 'wait';
  if (a >= 100) return 'done';
  if (a > 0) return 'ing';
  return 'wait';
}
function statusBadge(st) {
  const m = {done:['badge-done','ì™„ë£Œ'], ing:['badge-ing','ì§„í–‰ì¤‘'], wait:['badge-wait','ëŒ€ê¸°']};
  const [cls, txt] = m[st] || ['',''];
  return `<span class="badge ${cls}">${txt}</span>`;
}
function lvBadge(lv) {
  const m = {'1':'badge-lv1','2':'badge-lv2','3':'badge-lv3'};
  return `<span class="badge ${m[lv]||''}">${lv}</span>`;
}
const ORG_COLORS = ['org-0','org-1','org-2','org-3','org-4'];
const ORG_LIST = ['ì œì¼ì—”ì§€ë‹ˆì–´ë§','ì•„ì‚°ì‹œ','í˜¸ì„œëŒ€','ì¶©ë‚¨ì—°êµ¬ì›','KAIST'];
function orgChip(org) {
  const i = ORG_LIST.indexOf(org);
  return `<span class="org-chip ${ORG_COLORS[i>=0?i:0]}">${org||'-'}</span>`;
}
function pbarHtml(plan, actual) {
  const p = plan ?? 0, a = actual ?? 0;
  const color = a >= p ? 'var(--success)' : (p - a > 20 ? 'var(--danger)' : 'var(--warning)');
  return `<div class="pbar-wrap">
    <div class="pbar"><div class="pbar-fill" style="width:${Math.min(a,100)}%;background:${color}"></div></div>
    <span class="pbar-num">${a}%</span>
  </div>`;
}
function devHtml(dev) {
  if (dev === null) return '-';
  const cls = dev >= 0 ? 'dev-pos' : 'dev-neg';
  return `<span class="${cls}">${dev >= 0 ? '+' : ''}${dev}%</span>`;
}

// â”€â”€ KPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPI() {
  const lvl3 = allData.filter(r => r.level === '3' || r.level === 3);
  const done = lvl3.filter(r => status(r) === 'done').length;
  const actuals = lvl3.map(r => pct(r.actualRate)).filter(n => n !== null);
  const devs = lvl3.map(r => pct(r.deviation)).filter(n => n !== null);
  const avgActual = actuals.length ? Math.round(actuals.reduce((a,b)=>a+b,0)/actuals.length) : 0;
  const avgDev = devs.length ? Math.round(devs.reduce((a,b)=>a+b,0)/devs.length) : 0;

  document.getElementById('kpi-total').textContent = allData.length;
  document.getElementById('kpi-done').textContent = done;
  document.getElementById('kpi-avg-actual').textContent = avgActual + '%';
  document.getElementById('kpi-avg-dev').textContent = (avgDev >= 0 ? '+' : '') + avgDev + '%';
}

// â”€â”€ í•„í„° ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFilters() {
  const cats = [...new Set(allData.map(r=>r.category).filter(Boolean))];
  const orgs = [...new Set(allData.map(r=>r.organization).filter(Boolean))];
  const catSel = document.getElementById('f-cat');
  const orgSel = document.getElementById('f-org');
  cats.forEach(c => { const o=document.createElement('option'); o.value=o.textContent=c; catSel.appendChild(o); });
  orgs.forEach(c => { const o=document.createElement('option'); o.value=o.textContent=c; orgSel.appendChild(o); });
}

// â”€â”€ ì „ì²´ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllTable() {
  const lv   = document.getElementById('f-level').value;
  const cat  = document.getElementById('f-cat').value;
  const org  = document.getElementById('f-org').value;
  const st   = document.getElementById('f-status').value;

  const rows = allData.filter(r => {
    if (lv  && String(r.level) !== lv) return false;
    if (cat && r.category !== cat) return false;
    if (org && r.organization !== org) return false;
    if (st  && status(r) !== st) return false;
    return true;
  });

  const tbody = document.getElementById('tbody-all');
  tbody.innerHTML = rows.map(r => {
    const plan = pct(r.plannedRate), actual = pct(r.actualRate);
    const dev  = (plan !== null && actual !== null) ? actual - plan : null;
    return `<tr>
      <td><code>${r.taskId||''}</code></td>
      <td>${lvBadge(String(r.level))}</td>
      <td>${r.name||''}</td>
      <td>${r.category||'-'}</td>
      <td>${orgChip(r.organization)}</td>
      <td>${plan !== null ? plan+'%' : '-'}</td>
      <td>${pbarHtml(plan, actual)}</td>
      <td>${devHtml(dev)}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts() {
  // ëŒ€ë¶„ë¥˜ë³„ ì‹¤ì  ê³µì •ë¥ 
  const cats = [...new Set(allData.map(r=>r.category).filter(Boolean))];
  const catData = cats.map(c => {
    const rows = allData.filter(r => r.category === c && r.level === '3');
    const vals = rows.map(r=>pct(r.actualRate)).filter(n=>n!==null);
    return vals.length ? Math.round(vals.reduce((a,b)=>a+b)/vals.length) : 0;
  });
  new Chart(document.getElementById('chartCategory'), {
    type: 'bar',
    data: { labels: cats, datasets: [{ label: 'ì‹¤ì (%)', data: catData,
      backgroundColor: 'rgba(26,86,219,.7)', borderRadius: 4 }] },
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { y: { max: 100, ticks: { callback: v=>v+'%' } } } }
  });

  // ë‹´ë‹¹ê¸°ê´€ë³„ ìƒíƒœ ë¶„í¬
  const orgCounts = {};
  allData.filter(r=>r.level==='3').forEach(r => {
    const o = r.organization || 'ë¯¸ì§€ì •';
    if (!orgCounts[o]) orgCounts[o] = {done:0,ing:0,wait:0};
    orgCounts[o][status(r)]++;
  });
  const orgLabels = Object.keys(orgCounts);
  new Chart(document.getElementById('chartOrg'), {
    type: 'bar',
    data: {
      labels: orgLabels,
      datasets: [
        { label: 'ì™„ë£Œ', data: orgLabels.map(o=>orgCounts[o].done),  backgroundColor: 'rgba(15,157,88,.7)', borderRadius:2 },
        { label: 'ì§„í–‰ì¤‘', data: orgLabels.map(o=>orgCounts[o].ing), backgroundColor: 'rgba(26,86,219,.7)', borderRadius:2 },
        { label: 'ëŒ€ê¸°', data: orgLabels.map(o=>orgCounts[o].wait), backgroundColor: 'rgba(200,200,200,.7)', borderRadius:2 },
      ]
    },
    options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
  });
}

// â”€â”€ ëŒ€ë¶„ë¥˜ë³„ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCategoryCards() {
  const cats = [...new Set(allData.map(r=>r.category).filter(Boolean))];
  const container = document.getElementById('category-cards');
  container.innerHTML = cats.map(cat => {
    const rows = allData.filter(r => r.category === cat);
    const lv3  = rows.filter(r => r.level === '3');
    const avg  = lv3.length ? Math.round(lv3.map(r=>pct(r.actualRate)||0).reduce((a,b)=>a+b)/lv3.length) : 0;
    const done = lv3.filter(r=>status(r)==='done').length;
    const rows_html = rows.slice(0,8).map(r => {
      const a = pct(r.actualRate);
      return `<tr><td><code>${r.taskId}</code></td><td>${r.name||''}</td>
        <td>${pbarHtml(pct(r.plannedRate), a)}</td></tr>`;
    }).join('');
    return `<div class="card">
      <h3>ğŸ¯ ${cat}</h3>
      <div style="margin-bottom:10px;font-size:13px;color:var(--text-sub)">
        ì „ì²´ ${rows.length}ê±´ | Level3 ì™„ë£Œ ${done}/${lv3.length} | í‰ê·  ì‹¤ì  <b>${avg}%</b>
      </div>
      <div class="tbl-wrap" style="max-height:300px">
        <table><tbody>${rows_html}</tbody></table>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ ë‹´ë‹¹ê¸°ê´€ë³„ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOrgCards() {
  const orgs = [...new Set(allData.map(r=>r.organization).filter(Boolean))];
  const container = document.getElementById('org-cards');
  container.innerHTML = orgs.map((org,i) => {
    const rows = allData.filter(r => r.organization === org);
    const lv3  = rows.filter(r => r.level === '3');
    const avg  = lv3.length ? Math.round(lv3.map(r=>pct(r.actualRate)||0).reduce((a,b)=>a+b)/lv3.length) : 0;
    const rows_html = rows.slice(0,6).map(r => {
      const a = pct(r.actualRate);
      return `<tr><td><code>${r.taskId}</code></td><td>${r.name||''}</td>
        <td>${statusBadge(status(r))}</td></tr>`;
    }).join('');
    return `<div class="card">
      <h3><span class="org-chip ${ORG_COLORS[i%5]}">${org}</span></h3>
      <div style="margin-bottom:10px;font-size:13px;color:var(--text-sub)">
        ì „ì²´ ${rows.length}ê±´ | í‰ê·  ì‹¤ì  <b>${avg}%</b>
      </div>
      <div class="tbl-wrap" style="max-height:280px">
        <table><tbody>${rows_html}</tbody></table>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['all','category','org'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

loadData();
</script>
</body>
</html>
