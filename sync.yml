name: ğŸ”„ Auto Sync Notion WBS

on:
  # â° 15ë¶„ë§ˆë‹¤ ìë™ ë™ê¸°í™”
  schedule:
    - cron: '*/15 * * * *'
  
  # ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ê°•ì œ ì—…ë°ì´íŠ¸ (ë³€ê²½ì‚¬í•­ ì—†ì–´ë„ ë°°í¬)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  
  # ğŸ“ ì½”ë“œ ë³€ê²½ ì‹œ
  push:
    branches: [main]
    paths:
      - 'sync_notion.py'
      - 'index.html'
      - '.github/workflows/sync.yml'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "wbs-sync"
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================
  # 1. Notion ë°ì´í„° ë™ê¸°í™”
  # ============================================================
  sync:
    name: ğŸ“¥ Sync from Notion
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.sync.outputs.changed }}
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: pip install requests
      
      - name: ğŸ”„ Sync Notion databases
        id: sync
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: python sync_notion.py
      
      - name: ğŸ“Š Check sync result
        run: |
          if [ -f data/wbs-data.json ]; then
            echo "âœ… ë°ì´í„° íŒŒì¼ ìƒì„±ë¨"
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -c < data/wbs-data.json) bytes"
            echo "ğŸ“… ë™ê¸°í™” ì‹œê°„: $(jq -r '.metadata.synced_at' data/wbs-data.json)"
            echo "ğŸ“‹ ì´ í•­ëª©: $(jq -r '.metadata.total_items' data/wbs-data.json)"
          else
            echo "âŒ ë°ì´í„° íŒŒì¼ ì—†ìŒ"
          fi
      
      - name: ğŸ’¾ Commit changes
        if: steps.sync.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "ğŸ¤– WBS Sync Bot"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet data/; then
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git add data/
            
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            TOTAL=$(jq -r '.metadata.total_items' data/wbs-data.json 2>/dev/null || echo "?")
            UNIT=$(jq -r '.items.unit_project | length' data/wbs-data.json 2>/dev/null || echo "?")
            MGMT=$(jq -r '.items.management | length' data/wbs-data.json 2>/dev/null || echo "?")
            
            git commit -m "ğŸ”„ WBS ìë™ ë™ê¸°í™” [$(TZ='Asia/Seoul' date +'%Y-%m-%d %H:%M')]" \
                       -m "ğŸ“Š ì´ ${TOTAL}ê°œ (ë‹¨ìœ„ì‚¬ì—…: ${UNIT}, ì‚¬ì—…ê´€ë¦¬: ${MGMT})"
            
            git push
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
          fi

  # ============================================================
  # 2. GitHub Pages ë°°í¬
  # ============================================================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    needs: sync
    if: needs.sync.outputs.changed == 'true' || github.event.inputs.force_update == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ğŸ”„ Pull latest changes
        run: git pull origin main
      
      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"

  # ============================================================
  # 3. ì•Œë¦¼ (ì„ íƒì‚¬í•­ - Slack ì—°ë™ ì‹œ)
  # ============================================================
  # notify:
  #   name: ğŸ“¢ Send Notification
  #   needs: [sync, deploy]
  #   if: always() && needs.sync.outputs.changed == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Send to Slack
  #       uses: slackapi/slack-github-action@v1
  #       with:
  #         payload: |
  #           {
  #             "text": "ğŸ”„ WBS ëŒ€ì‹œë³´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "*ğŸ—ï¸ ì•„ì‚° ìŠ¤ë§ˆíŠ¸ì‹œí‹° WBS ì—…ë°ì´íŠ¸*\nëŒ€ì‹œë³´ë“œê°€ ìµœì‹  ë°ì´í„°ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
  #                 }
  #               }
  #             ]
  #           }
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
